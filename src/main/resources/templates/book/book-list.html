<!DOCTYPE html>

<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{layouts/base :: head(~{::title}, ~{::link})}">
    <title>북카이브 - 책 검색결과</title>
    <link rel="stylesheet" th:href="@{/assets/css/book.css}"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/libs/star-rating/star-rating.css}"/>
</head>

<body th:replace="~{layouts/base :: _body('book-result', ~{::div}, ~{::script}, false)}">
<div class="container-xxl flex-grow-1 container-p-y">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a class="btn-link" th:href="@{/}">홈</a>
        </li>
        <li class="breadcrumb-item active">
            <span class="text-primary" th:text="${param.query}"></span>에 대한 검색 결과
        </li>
    </ol>

    <div class="card">
        <div class="card-body" id="contentCard">
            <div th:replace="~{common/loading :: div}"></div>
            <div th:replace="~{common/result-message :: div}"></div>

            <ul id="bookSearchList" class="tp-list">
                <li data-goods-no="" class="template-tag">
                    <div class="item-unit row">
                        <div class="item-img">
                            <span class="img-item">
                                <a th:href="@{/book/book-detail}">
                                    <img class="img-thumbnail" src="">
                                </a>
                            </span>
                        </div>
                        <div class="item-info">
                            <div class="info-num d-none d-md-block">
                                <span class="badge bg-secondary fw-bold">
                                    <!-- 태그 동적으로 추가될 때 입력 -->
                                </span>
                            </div>

                            <div class="info-name">
                                <a th:href="@{/book/book-detail}" class="bk-name btn-link">
                                    <!-- 태그 동적으로 추가될 때 입력 -->
                                </a>
                            </div>

                            <div class="info-pub-grp">
                                <span class="info-auth">
                                    <a class="btn-link fw-medium" href=""><!-- 태그 동적으로 추가될 때 입력 --></a> 저
                                    <span class="d-none">
                                        <em class="text-body"><!-- 태그 동적으로 추가될 때 입력 --></em> 역
                                    </span>
                                </span>
                                <span class="info-pub">
                                    <span class="horizontal-divider"></span>
                                    <a class="btn-link fw-medium" href="">
                                        <!-- 태그 동적으로 추가될 때 입력 -->
                                    </a>
                                </span>
                                <span class="info-date d-none d-sm-inline-block">
                                    <span class="horizontal-divider"></span>
                                    <a>
                                        <!-- 태그 동적으로 추가될 때 입력 -->
                                    </a>
                                </span>
                            </div>

                            <div class="info-detail d-none d-md-block">
                                <p class="bk-intro ellipsis">
                                    <!-- 태그 동적으로 추가될 때 입력 -->
                                </p>
                            </div>

                            <div class="info-rating-wrap mt-auto">
                                <div class="info-rating d-none d-sm-block">
                                    <span class="sale-num">
                                        독자수 <em>0<!-- 태그 동적으로 추가될 때 입력 --></em>
                                    </span>
                                    <span class="rating-rv-count me-1">
                                        <span class="horizontal-divider"></span>
                                        리뷰(<em class="text-primary">0<!-- 태그 동적으로 추가될 때 입력 --></em>건)
                                    </span>
                                    <span class="rating-grade">
                                        <select class="star-rating star-rt-sm" data-value="" data-range="10" disabled>
                                        </select>
                                    </span>
                                </div>

                                <div class="info-rating d-inline-block d-sm-none">
                                    <span class="rating-grade">
                                        <select class="star-rating star-rt-sm non-label" data-value="" data-range="10"
                                                disabled>
                                        </select>
                                    </span>
                                    <span class="rating-detail">
                                        독자수 <em class="sale-num">0<!-- 태그 동적으로 추가될 때 입력 (data-value) --></em>
                                        리뷰수 <em class="rating-rv-count">0<!-- 태그 동적으로 추가될 때 입력 (data-value) --></em>
                                    </span>
                                </div>

                                <div class="item-btn-sm-col d-inline-block d-sm-none">
                                    <div class="btn-group">
                                        <button type="button"
                                                class="btn btn-icon rounded-pill btn-primary dropdown-toggle hide-arrow"
                                                data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="bx bxs-bookmark-plus"></i>
                                        </button>
                                        <ul class="dropdown-menu" style="">
                                            <!-- TODO: 상태에 따른 표시 목록
                                                추가 전 : 읽을 예정 ~ 읽음
                                                추가 후 : 읽을 예정 ~ 독서 포기 / 독서 목록에서 제거
                                            -->
                                            <li><a class="dropdown-item" href="javascript:void(0);">읽을 예정</a></li>
                                            <li><a class="dropdown-item" href="javascript:void(0);">읽는 중</a></li>
                                            <li><a class="dropdown-item" href="javascript:void(0);">읽음</a></li>
                                        </ul>
                                    </div>
                                    <button type="button" class="btn btn-icon rounded-pill btn-outline-primary toast-btn"
                                            data-bs-toggle="toast" data-bs-target="#toastCont">
                                        <i class="bx bx-folder"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="item-btn-col d-none d-sm-flex">
                            <div class="btn-group">
                                <button type="button" class="btn btn-md btn-primary dropdown-toggle"
                                        data-bs-toggle="dropdown" aria-expanded="false">
                                    독서 목록에 추가
                                </button>
                                <ul class="dropdown-menu" style="">
                                    <li><a class="dropdown-item" href="javascript:void(0);">읽을 예정</a></li>
                                    <li><a class="dropdown-item" href="javascript:void(0);">읽는 중</a></li>
                                    <li><a class="dropdown-item" href="javascript:void(0);">읽음</a></li>
                                </ul>
                            </div>
                            <button type="button" class="btn btn-md btn-outline-primary toast-btn"
                                    data-bs-toggle="toast" data-bs-target="#toastCont">
                                컬렉션에 추가
                            </button>
                        </div>
                    </div>
                </li>
            </ul>

            <nav th:replace="~{common/pagination :: nav}"></nav>
        </div>
    </div>
</div>

<script th:src="@{/assets/vendor/libs/star-rating/star-rating.js}"></script>
<script th:src="@{/assets/js/custom-rating.js}"></script>
<script>
    // TODO: (임시) 백엔드 붙일 때 뒷단 프로세스가 성공하면 해당 처리
    for (const el of document.getElementsByClassName('toast-btn')) {
        el.addEventListener('click', function () {
            const content = '컬렉션에 추가되었습니다.';
            showToast(content, 'success');
        })
    }

    document.addEventListener('DOMContentLoaded', function (e) {
        searchBooks();
    });

    /**
     * 책 검색 (쿼리스트링을 통해 파라미터 자동 처리)
     */
    function searchBooks() {
        hideNoResultsMessage(); // 검색 시작 시 결과 없음 메시지 숨김
        clearBookList(); // 이전 검색 결과 지우기
        showLoading(); // 로딩 시작

        axios.get('/api/books' + window.location.search)
            .then(response => {
                const data = response.data.data;
                if (data.item.length) {
                    appendBookElement(data);
                    setPagination(data.startIndex, data.totalPages);
                } else {
                    showNoResultMessage();
                }
                hideLoading();
            })
            .catch(error => {
                console.error('axios 요청 오류:', error);
                hideLoading();
            });
    }

    /**
     * 책 검색 결과 html 동적 추가
     */
    function appendBookElement(data) {
        const bookListWrap = document.getElementById('bookSearchList');
        const templateTag = bookListWrap.querySelector('.template-tag');
        if (templateTag) {
            data.item.forEach((item, idx) => {
                const li = templateTag.cloneNode(true);
                li.removeAttribute("class");

                li.setAttribute('data-goods-no', item.isbn);
                li.querySelector('.img-thumbnail').setAttribute('src', item.cover);
                li.querySelector('.info-num span').textContent = calculateRowIndex(data.startIndex, data.itemsPerPage, idx+1);
                li.querySelector('.info-name a').textContent = item.title;
                li.querySelector('.info-auth a').textContent = item.formatAuthor;
                if (item.translator) {
                    li.querySelector('.info-auth span').classList.remove("d-none");
                    li.querySelector('.info-auth span em').textContent = item.translator;
                }
                li.querySelector('.info-pub a').textContent = item.publisher;
                li.querySelector('.info-date a').textContent = item.pubDate;
                li.querySelector('.info-detail .bk-intro').textContent = item.description;
                // TODO: 평점 정보 연결
                // li.querySelector('.info-rating .sale-num em').textContent = '';
                // li.querySelector('.info-rating .rating-detail em.sale-num').textContent = '';
                // li.querySelector('.info-rating .rating-rv-count em').textContent = '';
                // li.querySelector('.info-rating .rating-detail em.rating-rv-count').textContent = '';
                // li.querySelector('.info-rating .rating-grade select').setAttribute('data-value', '');

                bookListWrap.append(li);
            })
        }
    }
    function clearBookList() {
        const bookListWrap = document.getElementById('bookSearchList');
        while (bookListWrap.children[1]) { // 첫번째 엘리먼트는 템플릿 태그이므로 제외
            bookListWrap.removeChild(bookListWrap.children[1]);
        }
    }
</script>
</body>
</html>
